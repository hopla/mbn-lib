
\chapter{API Reference}
\section{Defines}
This section documents a few global defines found in mbn.h. Not all defines are listed here, and some function-specific defines can be found in the documentation of that function.


\subsection{Node services}
Bit flags indicating the services of a node. The following flags are defined:
\begin{description}
 \item[MBN\_ADDR\_SERVICES\_SERVER]
  The node works as an address server.
 \item[MBN\_ADDR\_SERVICES\_ENGINE]
  The node has engine functionality.
 \item[MBN\_ADDR\_SERVICES\_ERROR]
  An error has occured in this node. (This flag is currently not used anywhere)
 \item[MBN\_ADDR\_SERVICES\_VALID]
  The node has a validated address and can communicate over the MambaNet network.
\end{description}


\subsection{Data types}
Objects can have sensors or actuators of various data types, the following types are defined:
\begin{description}
 \item[MBN\_DATATYPE\_NODATA]
  There's no data at all.
 \item[MBN\_DATATYPE\_UINT]
  Unsigned integer, can be from 1 to 4 bytes long.
 \item[MBN\_DATATYPE\_SINT]
  Signed integer, also 1 to 4 bytes.
 \item[MBN\_DATATYPE\_STATE]
  State data type, an unsigned integer with a defined set of possible values and interpretations. The actual meaning of the possible states can vary per node and object.
 \item[MBN\_DATATYPE\_OCTETS]
  Array of bytes, can hold at most 64 bytes.
 \item[MBN\_DATATYPE\_FLOAT]
  A floating point, can be of 1, 2 or 4 bytes.
 \item[MBN\_DATATYPE\_BITS]
  Up to 8 bytes, used for storing bit flags.
 \item[MBN\_DATATYPE\_OBJINFO]
  Special datatype for representing an \verb|mbn_object| structure.
 \item[MBN\_DATATYPE\_ERROR]
  Special datatype indicating an error. The data is a human readable ASCII string explaining the error. At most 64 bytes.
\end{description}


\subsection{Default node objects}
These defines represent the object numbers of the default node objects that every node should have. Refer to the MambaNet documentation for more information. All objects are sensors, except noted otherwise.
\begin{description}
 \item[MBN\_NODEOBJ\_DESCRIPTION] Description of the node.
 \item[MBN\_NODEOBJ\_NAME] Actuator, name of the node.
 \item[MBN\_NODEOBJ\_MANUFACTURERID] Manufacturer ID.
 \item[MBN\_NODEOBJ\_PRODUCTID] Product ID.
 \item[MBN\_NODEOBJ\_UNIQUEID] Unique ID per product.
 \item[MBN\_NODEOBJ\_HWMAJOR] Hardware major revision.
 \item[MBN\_NODEOBJ\_HWMINOR] Hardware minor revision.
 \item[MBN\_NODEOBJ\_FWMAJOR] Firmware major revision.
 \item[MBN\_NODEOBJ\_FWMINOR] Firmware minor revision.
 \item[MBN\_NODEOBJ\_FPGAMAJOR] FPGA major revision.
 \item[MBN\_NODEOBJ\_FPGAMINOR] FPGA minor revision.
 \item[MBN\_NODEOBJ\_PROTOMAJOR] Protocol major revision.
 \item[MBN\_NODEOBJ\_PROTOMINOR] Protocol minor revision.
 \item[MBN\_NODEOBJ\_NUMBEROFOBJECTS] Number of custom objects.
 \item[MBN\_NODEOBJ\_ENGINEADDRESS] Actuator, default engine address.
 \item[MBN\_NODEOBJ\_HWPARENT] Hardware parent.
 \item[MBN\_NODEOBJ\_SERVICEREQUEST] Service request.
\end{description}




\cleardoublepage
\section{Data types}
\textbf{Note:} Not all structures defined in mbn.h are documented here, only those that are useful for writing applications are included. Also keep in mind that the actual structure definitions may include more fields than those given in this document. These fields are intended for internal use. Refer to the source of mbn.h for the full definitions.


\subsection{mbn\_address\_node}
\begin{verbatim}
 struct mbn_address_node {
   unsigned short ManufacturerID, ProductID, UniqueIDPerProduct;
   unsigned long MambaNetAddr, EngineAddr;
   unsigned char Services;
 };
\end{verbatim}
This structure describes a MambaNet node as seen on the network. \textit{EngineAddr} is the default engine address for the node, and can be 0 if none is set. \textit{Services} is a set of \verb|MBN_ADDR_SERVICES_*| flags.


\subsection{mbn\_handler}
This structure identifies a MambaNet node and holds all data related to this node. All content in this struct is handled by the library functions, there should be no need to manually access information in it.


\subsection{mbn\_data}
\begin{verbatim}
 union mbn_data {
   long SInt;
   float Float;
   unsigned long UInt;
   unsigned long State;
   unsigned char Bits[8];
   unsigned char *Octets;
   char *Error;
   struct mbn_object *Info;
 };
\end{verbatim}
This union holds object data for various types. The actual type used in each situation is defined outside of the union, usually by an other member in the same structure, or in some situations it is assumed to be known to the programmer. To preserve memory, the larger data types \textit{Octets}, \textit{Error} and \textit{Info} are pointers.


\subsection{mbn\_if\_ethernet}
\begin{verbatim}
#ifdef MBN_IF_ETHERNET
 struct mbn_if_ethernet {
   struct mbn_if_ethernet *next;
   char *desc;
   char *name;
   unsigned char addr[6];
 };
#endif
\end{verbatim}
Defines a singly linked list of ethernet interfaces. \textit{addr} contains the MAC address of the interface in raw bytes. See the EthernetIFList() function for more information on the other fields and on how to use the data.


\subsection{mbn\_interface}
\begin{verbatim}
 struct mbn_interface {
   void *data;
   mbn_cb_InitInterface cb_init;
   mbn_cb_FreeInterface cb_free;
   mbn_cb_FreeInterfaceAddress cb_free_addr;
   mbn_cb_InterfaceTransmit cb_transmit;
 };
\end{verbatim}
Defines an interface module. The \textit{data} pointer can be freely used by the interface code for internal storage. The \verb|mbn_cb_<callback>| names are typedefs for the function callbacks as described in section\ \ref{sec:cb}.
The interface module is responsible for creating and initializing this structure.


\subsection{mbn\_message}
\begin{verbatim}
 struct mbn_message {
   unsigned char AcknowledgeReply;
   unsigned long AddressTo, AddressFrom;
   unsigned int MessageID;
   unsigned short MessageType;
   union {
     struct mbn_message_address Address;
     struct mbn_message_object Object;
   } Message;
   unsigned char *raw, buffer[98];
   int rawlength, bufferlength;
 };
\end{verbatim}
Defines a MambaNet message. \textit{AcknowledgeReply} is 1 to indicate that this message is a reply to an acknowledge request, the \textit{MessageID} should then indicate to which message it is a reply to. If \textit{MessageID} is not 0 but \textit{AcknowledgeReply} is, then the message is an acknowledge request.

\textit{AddressTo} and \textit{AddressFrom} are the MambaNet addresses of the intended receiving node and the sending node. \textit{AddressTo} can be \verb|MBN_BROADCAST_ADDRESS| for messages intended for everyone on the network. When sending messages, see mbnSendMessage() for details on how these fields are handled.

The \textit{MessageType} field should be one of \verb|MBN_MSGTYPE_ADDRESS| in case of an address message (see \verb|mbn_message_address|) or \verb|MBN_MSGTYPE_OBJECT| for an object message (\verb|mbn_message_object|). This specifies which \textit{Message} structure should be used.

The field \textit{raw} holds the raw message data of \textit{rawlength} bytes, and the \textit{buffer} field holds the 7-to-8bit decoded data part of the message of \textit{bufferlength}. These fields are mostly used internally and have no real use outside of the library.


\subsection{mbn\_message\_address}
\begin{verbatim}
 struct mbn_message_address {
   unsigned char Action;
   unsigned short ManufacturerID, ProductID, UniqueIDPerProduct;
   unsigned long MambaNetAddr, EngineAddr;
   unsigned char Services;
 };
\end{verbatim}
This structure holds a MambaNet address message. \textit{Services} is a set of \verb|MBN_ADDR_SERVICES_*| flags describing the node services. \textit{Action} can be either of the following:
\begin{description}
 \item[MBN\_ADDR\_ACTION\_INFO]
  Address reservation information message. Provides information about the address status, UniqueMediaAccessID, engine address and services of the sending node.
 \item[MBN\_ADDR\_ACTION\_PING]
  Requests other nodes to send an \verb|MBN_ADDR_ACTION_INFO| message. The fields can be used to match on which nodes should reply. 0 can be used as wildcard.
 \item[MBN\_ADDR\_ACTION\_RESPONSE]
  Unlike its name suggests, this message tells a node with a matching UniqueMediaAccessID to use the MambaNet address and engine address in the message as their own, and assume it as validated.
\end{description}


\subsection{mbn\_message\_object}
\begin{verbatim}
 struct mbn_message_object {
   unsigned short Number;
   unsigned char Action;
   unsigned char DataType;
   unsigned char DataSize;
   union mbn_data Data;
 };
\end{verbatim}
Defines an object message. \textit{Number} starts at 1024 for custom objects, default node objects start from 0. \textit{Action} can be one of the following:
\begin{description}
 \item[MBN\_OBJ\_ACTION\_GET\_INFO]
 \item[MBN\_OBJ\_ACTION\_INFO\_RESPONSE]
 \item[MBN\_OBJ\_ACTION\_GET\_ENGINE]
 \item[MBN\_OBJ\_ACTION\_ENGINE\_RESPONSE]
 \item[MBN\_OBJ\_ACTION\_SET\_ENGINE]
 \item[MBN\_OBJ\_ACTION\_GET\_FREQUENCY]
 \item[MBN\_OBJ\_ACTION\_FREQUENCY\_RESPONSE]
 \item[MBN\_OBJ\_ACTION\_SET\_FREQUENCY]
 \item[MBN\_OBJ\_ACTION\_GET\_SENSOR]
 \item[MBN\_OBJ\_ACTION\_SENSOR\_RESPONSE]
 \item[MBN\_OBJ\_ACTION\_SENSOR\_CHANGED]
 \item[MBN\_OBJ\_ACTION\_GET\_ACTUATOR]
 \item[MBN\_OBJ\_ACTION\_ACTUATOR\_RESPONSE]
 \item[MBN\_OBJ\_ACTION\_SET\_ACTUATOR]
\end{description}


\subsection{mbn\_node\_info}
\begin{verbatim}
 struct mbn_node_info {
   unsigned int MambaNetAddr;
   char Services;
   char Description[64];
   char Name[32];
   unsigned short ManufacturerID, ProductID, UniqueIDPerProduct;
   unsigned char HardwareMajorRevision, HardwareMinorRevision;
   unsigned char FirmwareMajorRevision, FirmwareMinorRevision;
   unsigned char FPGAFirmwareMajorRevision, FPGAFirmwareMinorRevision;
   unsigned short NumberOfObjects;
   unsigned int DefaultEngineAddr;
   unsigned char HardwareParent[6];
   unsigned char ServiceRequest;
 };
\end{verbatim}
Holds all information required about the MambaNet node. \textit{MambaNetAddr} indicates the current MambaNet address of the node, and can be 0 if it doesn't have one (yet). \textit{Services} is a set of \verb|MBN_ADDR_SERVICES_*| flags. Any of the \textit{-Revision} fields can be 0 to indicate that the item is not present or does not have a version number assigned. \textit{DefaultEngineAddr} can be 0 to indicate that no default engine address is set. The \textit{ServiceRequest} field should be either 1 to indicate that the node requires service, or 0 otherwise.

\textit{HardwareParent} specifies the UniqueMediaAccessID of the MambaNet node that is the ``hardware parent'' of this node in the format 0xMMMMPPPPUUUU, where M is the ManufacturerID, P the ProductID and U the UniqueIDPerProduct. Can be 0x000000000000 or the UniqueMediaAccessID of the current node if no hardware parent is present.

The protocol major and minor revisions are defined within the library as such not configurable and not defined in this structure.


\subsection{mbn\_object}
\begin{verbatim}
 struct mbn_object {
   char Description[32];
   unsigned char Services;
   unsigned char UpdateFrequency;
   unsigned char SensorType;
   unsigned char SensorSize;
   union mbn_data SensorMin, SensorMax;
   union mbn_data SensorData;
   unsigned char ActuatorType;
   unsigned char ActuatorSize;
   union mbn_data ActuatorMin, ActuatorMax;
   union mbn_data ActuatorDefault;
   union mbn_data ActuatorData;
 };
\end{verbatim}
Defines a custom object. \textit{SensorData} and \textit{ActuatorData} refer to the ``current'' data in use. The data type of the \textit{SensorMin}, \textit{SensorMax} and \textit{SensorData} fields is as indicated by \textit{SensorType}, with the exception that \textit{SensorMin} and \textit{SensorMax} are of type UInt if the type is \verb|MBN_DATATYPE_OCTETS| or \verb|MBN_DATATYPE_BITS|. The same holds true for the \textit{Actuator*} fields, where \textit{ActuatorDefault} is of the same type as \textit{ActuatorMin} and \textit{ActuatorMax}.




\cleardoublepage
\section{Functions}
\subsection{mbnCANOpen}
\begin{verbatim}
#ifdef MBN_IF_CAN
 struct mbn_interface *mbnCANOpen(char *ifname,
                                  char *error);
#endif
\end{verbatim}
Opens a connection to the CAN interface specified by \textit{ifname}, returning a pointer to an initialized \verb|mbn_interface| structure for use with mbnInit(). On error, \verb|NULL| is returned and an error message is available in \textit{error}, which should be able to hold at most \verb|MBN_ERRSIZE| bytes.

\textbf{Important:} The current CAN interface module is only supposed to be used as a gateway, and should not be used for normal MambaNet nodes that communicate on the CAN bus. It is the responsibility of the programmer to make sure that only one gateway is connected to one CAN bus at a time!


\subsection{mbnEthernetIFFree}
\begin{verbatim}
#ifdef MBN_IF_ETHERNET
 void mbnEthernetIFFree(struct mbn_if_ethernet *iflist);
#endif
\end{verbatim}
Deallocates the ethernet interface list returned by mbnEthernetIFList().


\subsection{mbnEthernetIFList}
\begin{verbatim}
#ifdef MBN_IF_ETHERNET
 struct mbn_if_ethernet *mbnEthernetIFList(char *error);
#endif
\end{verbatim}
Returns a linked list \verb|mbn_if_ethernet| structures, describing the available and usable ethernet interfaces on the current machine. This list should be freed using mbnEthernetIFFree() after use. On error, \verb|NULL| is returned, and \textit{error} will contain the error message in at most \verb|MBN_ERRSIZE| bytes.

The \textit{desc} member can be \verb|NULL| if no description could be obtained. The \textit{name} member uniquely identifies the interface and can be used as argument to mbnEthernetOpen().

Note that on windows, ethernet interfaces without an associated IPv4 address can not be used due to a limitation in the MAC address detection code, and will thus not be returned.


\subsection{mbnEthernetOpen}
\begin{verbatim}
#ifdef MBN_IF_ETHERNET
 struct mbn_interface *mbnEthernetOpen(char *ifname,
                                       char *error);
#endif
\end{verbatim}
Opens the ethernet interface described by \textit{ifname} and allocates an \verb|mbn_interface| structure for use for mbnInit(). Returns \verb|NULL| on error and an error string is written to \textit{error}, which should have enough space for at least \verb|MBN_ERRSIZE| bytes. \textit{ifname} can be obtained from mbnEthernetIFList().


\subsection{mbnForceAddress}
\begin{verbatim}
 void mbnForceAddress(struct mbn_handler *mbn,
                      unsigned long addr);
\end{verbatim}
Forces the MambaNet node \textit{mbn} to use address \textit{addr} and consider this address as validated. Should only be used by address servers or applications with multiple MambaNet nodes on different network interfaces.


\subsection{mbnFree}
\begin{verbatim}
 void mbnFree(struct mbn_handler *mbn);
\end{verbatim}
Deallocates all resources and closes all connections associated to the MambaNet node handler pointed to by \textit{mbn}. After mbnFree(), \textit{mbn} should not be used as argument to any other function.

\emph{IMPORTANT:} Do not call this function from within a callback routine. Doing so may lead to unexpected results.

\emph{Note:} Due to a limitation in the implementation, this command can block up to a few seconds on windows.


\subsection{mbnGetActuatorData}
\begin{verbatim}
 void mbnGetActuatorData(struct mbn_handler *mbn,
                         unsigned long addr,
                         unsigned short object,
                         char acknowledge);
\end{verbatim}
Requests the actuator data of a node on the network and dispatch an ActuatorDataResponse() callback on receiving the response. See mbnGetSensorData() for details.


\subsection{mbnGetObjectFrequency}
\begin{verbatim}
 void mbnGetObjectFrequency(struct mbn_handler *mbn,
                            unsigned long addr,
                            unsigned short object,
                            char acknowledge);
\end{verbatim}
Requests the object frequency state of a node on the network and dispatch an ObjectFrequencyResponse() callback on receiving the response. See mbnGetSensorData() for details.


\subsection{mbnGetObjectInformation}
\begin{verbatim}
 void mbnGetObjectInformation(struct mbn_handler *mbn,
                              unsigned long addr,
                              unsigned short object,
                              char acknowledge);
\end{verbatim}
Requests the object information of a node on the network and dispatch an ObjectInformationResponse() callback on receiving the response. See mbnGetSensorData() for details.


\subsection{mbnGetSensorData}
\begin{verbatim}
 void mbnGetSensorData(struct mbn_handler *mbn,
                       unsigned long addr,
                       unsigned short object,
                       char acknowledge);
\end{verbatim}
Requests the sensor data of object number \textit{object} of the node at MambaNet address \textit{addr}. The SensorDataResponse() callback will be called with the sensor data upon receiving the reply.

When the \textit{acknowledge} argument is set to $1$, the message will be sent using the \verb|MBN_SEND_ACKOWLEDGE| flag to mbnSendMessage(). Using this option, the MambaNet library will automatically retry the get operation, and an AcknowledgeTimeout callback will be dispatched if the sensor data could not be received after 5 retries.


\subsection{mbnInit}
\begin{verbatim}
 struct mbn_handler *mbnInit(struct mbn_node_info *info,
                             struct mbn_object *objects,
                             struct mbn_interface *itf,
                             char *error);
\end{verbatim}
This function creates a new MambaNet node, the \textit{info} argument should point to a fully initialized \verb|mbn_node_info| structure with information about this node.

\textit{objects} should point to an array of initialized \verb|mbn_object| structures, or \verb|NULL| if the node has no custom objects. The length of the array is determined from \textit{info.NumberOfObjects}. The library creates an internal copy of the entire objects array, so any application-allocated memory for the object list can be freed after the call to mbnInit(). The value of the \textit{Services} field of the \verb|mbn_object| structures is ignored, this is handled internally.

\textit{itf} should point to an \verb|mbn_interface| structure describing how the library can communicate to the outside. This pointer can be created using mbnEthernetOpen() or mbnTCPOpen(). \textbf{Important:} An interface pointer should be associated to only one MambaNet node!

On success, mbnInit() returns a pointer to an \verb|mbn_handler| structure which can be used to perform operations on the newly created MambaNet node. On error, \verb|NULL| is returned and an error string is written to \textit{error}, which should have enough space for at least \verb|MBN_ERRSIZE| bytes.


\subsection{mbnInterfaceReadError \footnotesize{[macro]}}
\begin{verbatim}
 void mbnInterfaceReadError(struct mbn_interface *itf,
                            char *error);
\end{verbatim}
This is a macro for use by interface modules. Should be called whenever there was a fatal error upon reading from the interface, such as losing the remote connection for TCP or when the device is not accessible for Ethernet. \textit{error} should be a human readable string describing what went wrong.

This macro expands to an if-statement calling the Error() callback to the application. \textit{itf} should have been linked to a MambaNet node using mbnInit() before being used in this macro.


\subsection{mbnNodeStatus}
\begin{verbatim}
 struct mbn_address_node *mbnNodeStatus(struct mbn_handler *mbn,
                                        unsigned long addr);
\end{verbatim}
This function returns the status information of the MambaNet node at address \textit{addr}, or \verb|NULL| if the node is not found in the internal node list.


\subsection{mbnNextNode}
\begin{verbatim}
 struct mbn_address_node *mbnNextNode(struct mbn_handler *mbn,
                                      struct mbn_address_node *node);
\end{verbatim}
mbnNextNode() can be used to browse through the list of online nodes seen by MambaNet node \textit{mbn}. Specifying \verb|NULL| as \textit{node} will return the first address in the list, specifying an existing node will return the next node in the list, or \verb|NULL| if the node was not found.

Note that after calling mbnInit(), it can take up to 30 seconds for all nodes on the network to be in the local node list. Use mbnSendPingRequest() if you need this information at an earlier point.


\subsection{mbnProcessRawMessage}
\begin{verbatim}
 void mbnProcessRawMessage(struct mbn_interface *itf,
                           unsigned char *buffer,
                           int bufferlength,
                           void *ifaddr);
\end{verbatim}
This command should only be called by an interface module. Processes a raw packet from the network and sends the appropriate callbacks to the application. \textit{itf} should point to the \verb|mbn_interface| structure of the interface this message was received on. This interface must have previously been linked to a MambaNet node using mbnInit().


\subsection{mbnSendMessage}
\begin{verbatim}
 void mbnSendMessage(struct mbn_handler *mbn,
                     struct mbn_message *msg,
                     int flags);
\end{verbatim}
Sends a custom message pointed to by \textit{msg} over the network from the perspective of the MambaNet node \textit{mbn}. The interpretation of the members in the \verb|mbn_message| structure can be influenced using the following \textit{flags}. Keep in mind that most of these flags are meant for internal use, and rarely have any use in an application.
\begin{description}
  \item[MBN\_SEND\_IGNOREVALID]
   Normally, mbnSendMessage() will refuse to send a message if the MambaNet address of the node has not been validated. Setting this flag will disable this check.
  \item[MBN\_SEND\_FORCEADDR]
   Don't overwrite the source address of the message. Without this flag, the value of the \textit{AddressFrom} member of the message will be ignored and the message will be sent with the address of the current MambaNet node.
  \item[MBN\_SEND\_NOCREATE]
   Ignore the \textit{Message} field of the structure, and use the raw bytes in the \textit{buffer} member as data for the message.
  \item[MBN\_SEND\_RAWDATA]
   Send the raw packet in the \textit{raw} member. This flag is equivalent to simply broadcasting raw bytes to the network.
  \item[MBN\_SEND\_ACKOWLEDGE]
   Request this message to be acknowledged by the receiver. The message will be re-sent up to 5 times for each second that no acknowledge reply has been received.
  \item[MBN\_SEND\_FORCEID]
   Don't overwrite the \textit{MessageID} member of the message. Without this flag, mbnSendMessage() will automatically use a Message ID depending on the ACKNOWLEDGE flag.
\end{description}


\subsection{mbnSendPingRequest}
\begin{verbatim}
 void mbnSendPingRequest(struct mbn_handler *mbn,
                         unsigned long addr);
\end{verbatim}
Sends a ping request to MambaNet address \textit{addr}, or to all nodes on the network by specifying \verb|MBN_BROADCAST_ADDRESS|.


\subsection{mbnSetActuatorData}
\begin{verbatim}
 void mbnSetActuatorData(struct mbn_handler *mbn,
                         unsigned long addr,
                         unsigned short object,
                         unsigned char type,
                         unsigned char length,
                         union mbn_data data,
                         char acknowledge);
\end{verbatim}
Sets the actuator data of object number \textit{object} of the MambaNet node with address \textit{addr} to \textit{data}. The values of the \textit{type} and \textit{length} arguments should match the actuator data type and length configured in the target node. This information can be requested by using mbnGetObjectInformation(). The \textit{acknowledge} argument behaves the same as for mbnGetSensorData().


\subsection{mbnSet$<$cb$>$Callback \footnotesize{[macro]}}
\begin{verbatim}
 void mbnSet<cb>Callback(struct mbn_handler *mbn,
                                mbn_cb_<cb>Callback *func);
\end{verbatim}
A set of macros to set callback function \verb|<cb>| for the MambaNet node \textit{mbn} to function \textit{func}. See section\ \ref{sec:cb} for the list of callback functions. See also mbnUnset$<$cb$>$Callback() for removing callback functions.

Please note that callback functions intended to be used by interface modules can \textbf{not} be set using these macros, these have to be set on the creation of the \verb|mbn_interface| structure.


\subsection{mbnSetObjectFrequency}
\begin{verbatim}
 void mbnSetObjectFrequency(struct mbn_handler *mbn,
                            unsigned long addr,
                            unsigned short object,
                            unsigned char freq,
                            char acknowledge);
\end{verbatim}
Sets the object frequency state of object number \textit{object} of the MambaNet node with address \textit{addr} to \textit{freq}. The \textit{acknowledge} argument behaves the same as for mbnGetSensorData().


\subsection{mbnTCPOpen}
\begin{verbatim}
#ifdef MBN_IF_TCP
 struct mbn_interface *mbnTCPOpen(char *remotehost,
                                  char *remoteport,
                                  char *localhost,
                                  char *localport,
                                  char *error);
#endif
\end{verbatim}
Opens TCP connection(s) and allocates an \verb|mbn_interface| structure for use for mbnInit(). On error, \verb|NULL| is returned and an error string is written to \textit{error}, which should have enough space for at least \verb|MBN_ERRSIZE| bytes.

If \textit{remotehost} is not \verb|NULL|, a connection will be made to the server listening at port \textit{remoteport} on \textit{remotehost}. If \textit{localhost} is not \verb|NULL|, the library will act as a TCP server and listen for incoming connections on port \textit{localport}. \textit{remoteport} and \textit{localport} can be \verb|NULL| to use the default port for MambaNet. \textit{remotehost} and \textit{localhost} can be either an hostname or a numeric IP addresses. Both IPv4 and IPv6 are supported.

\emph{Note:} This function performs hostname lookups and opens connections in a non-blocking fasion. It can block up to a few minutes in the worst case.


\subsection{mbnUnset$<$cb$>$Callback \footnotesize{[macro]}}
\begin{verbatim}
 void mbnUnset<cb>Callback(struct mbn_handler *mbn);
\end{verbatim}
Set of macros to remove callback function \verb|<cb>| from MambaNet node \textit{mbn}. 


\subsection{mbnUpdateActuatorData}
\begin{verbatim}
 void mbnUpdateActuatorData(struct mbn_handler *mbn,
                            unsigned short object,
                            union mbn_data data);
\end{verbatim}
Changes the actuator data of custom object \textit{object} (counting from 0) of MambaNet node \textit{mbn} to \textit{data}.


\subsection{mbnUpdateEngineAddr}
\begin{verbatim}
 void mbnUpdateEngineAddr(struct mbn_handler *mbn,
                          unsigned long addr);
\end{verbatim}
Changes the default engine address of MambaNet node \textit{mbn} to \textit{addr}. Specifying $0$ as address will remove the current default engine address.


\subsection{mbnUpdateNodeName}
\begin{verbatim}
 void mbnUpdateNodeName(struct mbn_handler *mbn,
                        char *name);
\end{verbatim}
Allows the name of MambaNet node \textit{mbn} to be set after the node has been created by mbnInit().


\subsection{mbnUpdateSensorData}
\begin{verbatim}
 void mbnUpdateSensorData(struct mbn_handler *mbn,
                          unsigned short object,
                          union mbn_data data);
\end{verbatim}
Does the same as mbnUpdateActuatorData, but updates the sensor data instead of the actuator. Depending on the frequency setting of the object, sensor data change messages may be sent to other nodes on the network to indicate that the sensor data has been changed.


\subsection{mbnUpdateServiceRequest}
\begin{verbatim}
 void mbnUpdateServiceRequest(struct mbn_handler *mbn,
                              char sreq);
\end{verbatim}
Updates the service request state of the MambaNet node \textit{mbn} to \textit{sreq}. Valid values are $1$ to indicate that this node requires service, or $0$ otherwise.


\subsection{MBN\_OBJ}
\begin{verbatim}
#define MBN_VARARG
#include "mbn.h"
 struct mbn_object MBN_OBJ(char *description,
                           unsigned char frequency,
                           ...);
\end{verbatim}
MBN\_OBJ() is a helper function to create the custom object list for use as argument to mbnInit(). To avoid linking problems on some platforms, this function has been implemented directly in the main header file of the library, \textit{mbn.h}. The function will be available after defining the \verb|MBN_VARARG| macro before including \textit{mbn.h}. Your compiler must have support for variable argument functions as defined in stdarg.h in ANSI C.

This function returns an initialized \verb|mbn_object| structure, of which the fields are defined by the arguments passed to the funcion. The \textit{description} and \textit{frequency} arguments directly map to the Description and UpdateFrequency fields. The Services field is ignored by mbnInit() and can thus not be specified using this function.

The argument after \textit{frequency} should indicate the SensorType. For data types other than \verb|MBN_DATATYPE_NODATA|, the four arguments after the SensorType map to the SensorSize, SensorMin, SensorMax and SensorData, in that order. The SensorMin, SensorMax and SensorData arguments should be passed in the type for that data type. For example, if SensorType is \verb|MBN_DATATYPE_FLOAT|, the arguments are expected to be passed as a floating point. For \verb|MBN_DATATYPE_NODATA|, no subsequent arguments are required for defining the sensor part of the structure.

After defining the sensor part, the actuator part should be specified in the same manner: The first argument maps to the ActuatorType, and if this type is other than \verb|MBN_DATATYPE_NODATA|, the type argument should be followed by five arguments mapping to ActuatorSize, ActuatorMin, ActuatorMax, ActuatorDefault and ActuatorData, in that order.




\cleardoublepage
\section{Callbacks}
\label{sec:cb}

\subsection{AcknowledgeReply}
\begin{verbatim}
 void AcknowledgeReply(struct mbn_handler *mbn,
                       struct mbn_message *request,
                       struct mbn_message *reply,
                       int retries);
\end{verbatim}
This callback will be dispatched upon receiving an acknowledge reply from the network. The \textit{request} argument is the message that was previously sent by the MambaNet node \textit{mbn}, the \textit{reply} argument is the message the node sent back as reply. \textit{retries} indicates the number of times the message has been re-sent before receiving this reply.


\subsection{AcknowledgeTimeout}
\begin{verbatim}
 void AcknowledgeTimeout(struct mbn_handler *mbn,
                         struct mbn_message *message);
\end{verbatim}
Called when a message was sent with the \verb|MBN_SEND_ACKNOWLEDGE|, but when no reply has been received after 5 seconds. \textit{mbn} is the MambaNet node from which the message was sent, and \textit{message} the message that did not receive a reply from the targeted node.


\subsection{ActuatorDataResponse}
\begin{verbatim}
 int ActuatorDataResponse(struct mbn_handler *mbn,
                          struct mbn_message *message,
                          unsigned short object,
                          unsigned char type,
                          union mbn_data data);
\end{verbatim}
Called on receiving an actuator data response message from another node, usually after calling mbnGetActuatorData(). \textit{object} is the object number, \textit{type} the data type and \textit{data} the actuator data for that object. The actual message that triggered this callback can be accessed from \textit{message}.

The callback should return 0 if this action should be considered as ``handled'', or any other value otherwise. When an action is considered as handled, the MambaNet library will automatically reply to the message if an acknowledge reply was requested by the sending node.


\subsection{AddressTableChange}
\begin{verbatim}
 void AddressTableChange(struct mbn_handler *mbn,
                         struct mbn_address_node *old,
                         struct mbn_address_node *new);
\end{verbatim}
This callback signals any changes in the internal node list to the application. When a new node has been detected on the network, \textit{old} will be \verb|NULL| and \textit{new} points to a \verb|mbn_address_node| structure with information about the new node. When the address information of a node changes, \textit{old} indicates the previous known and \textit{new} the updated information. On removal of a node from the network, \textit{old} will contain the previously known information of the node and \textit{new} will be \verb|NULL|.


\subsection{DefaultEngineAddrChange}
\begin{verbatim}
 int DefaultEngineAddrChange(struct mbn_handler *mbn,
                             unsigned long addr);
\end{verbatim}
Called when a node on the network attempts to change the default engine address of MambaNet node \textit{mbn} to \textit{addr}. The function should return 0 to indicate that the new engine address has been accepted or any other value otherwise. If the new engine has been accepted, the internal configuration will be updated (so calling mbnUpdateEngineAddr() won't be necessary) and the message will be replied to if an acknowledge reply was requested by the sending node.


\subsection{Error}
\begin{verbatim}
 void Error(struct mbn_handler *mbn,
            int code,
            char *str);
\end{verbatim}
Called whenever an error occurs in MambaNet node \textit{mbn}. \textit{str} points to a human readable error string describing what went wrong, \textit{code} will be one of the following:
\begin{description}
 \item[MBN\_ERROR\_NO\_INTERFACE]
  Attempted to send a message to the network, but the interface specified by mbnInit() does not have a transmit function.
 \item[MBN\_ERROR\_INVALID\_ADDR]
  Attempted to send a message to the network without the  \verb|MBN_SEND_IGNOREVALID| flag to mbnSendMessage() from a node which does not have a validated MambaNet address.
 \item[MBN\_ERROR\_CREATE\_MESSAGE]
  An error occured while formatting a message for sending over the network, this is caused by calling mbnSendMessage() with an incorrect \verb|mbn_message| structure.
 \item[MBN\_ERROR\_PARSE\_MESSAGE]
  An incorrectly formatted message has been received from the network.
 \item[MBN\_ERROR\_ITF\_READ]
  An error occured while reading from the network. An application should assume that after receiving this error, no further packets will be received.
 \item[MBN\_ERROR\_ITF\_WRITE]
  Couldn't send a packet to the network. This could either be a temporary problem and further packets can be sent, or a fatal error and no futher packets can be sent.
\end{description}

Also refer to the ObjectError() callback for handling errors received from other nodes on the network.


\subsection{FreeInterface \footnotesize{[interface]}}
\begin{verbatim}
 void FreeInterface(mbn_interface *itf);
\end{verbatim}
Only to be used by interface modules. This callback will be called from mbnFree(), and should free all memory of the \verb|mbn_interface| structure and close all connections and other resources.


\subsection{FreeInterfaceAddress \footnotesize{[interface]}}
\begin{verbatim}
 void FreeInterfaceAddress(void *ifaddr);
\end{verbatim}
Only to be used by interface modules. This callback should free the memory pointed to by \textit{ifaddr}, which points to an memory location previously given to mbnProcessRawMessage().


\subsection{GetSensorData}
\begin{verbatim}
 int GetSensorData(struct mbn_handler *mbn,
                   unsigned short object,
                   union mbn_data *data);
\end{verbatim}
Called when a node on the network requests the sensor data of custom object number \textit{object} (counting from 0) on MambaNet node \textit{mbn}. To reply to this request, the sensor data of the object should be written to \textit{data}, and the callback should return 0. The request can be ignored by returning anything other than 0.

If this callback has not been set, the request will be replied to automatically with the sensor data known internally to the library, as set by the last call to mbnInit() or mbnUpdateSensorData().


\subsection{InitInterface \footnotesize{[interface]}}
\begin{verbatim}
 int InitInterface(struct interface *itf,
                   char *error);
\end{verbatim}
Only to be used by interface modules. Called from mbnInit(), this gives the interface module \textit{itf} the chance to do some initialization and tells the module to start waiting for packets and to call mbnProcessRawMessage() upon receiving anything.

The function should return 0 on success and 1 if something went wrong, in which case an error string should be written to \textit{error}, which is large enough to hold at least \verb|MBN_ERRSIZE| bytes.


\subsection{InterfaceTransmit \footnotesize{[interface]}}
\begin{verbatim}
 int InterfaceTransmit(struct mbn_interface *itf,
                       unsigned char *buffer,
                       int buflen,
                       void *ifaddr,
                       char *error);
\end{verbatim}
Tells interface module \textit{itf} to write \textit{buffer} (of \textit{buflen} bytes) to the network. \textit{ifaddr} points to the interface address of the destination MambaNet node, or \verb|NULL| if no interface address is known or the message should be broadcasted to all nodes.


\subsection{NameChange}
\begin{verbatim}
 int NameChange(struct mbn_handler *mbn,
                char *name);
\end{verbatim}
Called when a node on the network attempts to change the name of MambaNet node \textit{mbn} to \textit{name}. Works the same as the DefaultEngineAddrChange() callback.


\subsection{ObjectError}
\begin{verbatim}
 void ObjectError(struct mbn_handler *mbn,
                  struct mbn_message *message,
                  unsigned short object,
                  char *error);
\end{verbatim}
Called on receiving any object message with the \verb|MBN_DATATYPE_ERROR| datatype. \textit{object} is the object number of the object that the error originated from, and \textit{error} points to a human readable error string. The received message can be accessed using \textit{message}.


\subsection{ObjectFrequencyChange}
\begin{verbatim}
 void ObjectFrequencyChange(struct mbn_handler *mbn,
                            unsigned short object,
                            unsigned char freq);
\end{verbatim}
Signals to the application that the send frequency of object number \textit{object} has been changed to \textit{freq} by another node on the network. No further action by the application is required, as object frequencies are handled internally by the library.


\subsection{ObjectFrequencyResponse}
\begin{verbatim}
 int ObjectFrequencyResponse(struct mbn_handler *mbn,
                             struct mbn_message *message,
                             unsigned short object,
                             unsigned char freq);
\end{verbatim}
Called on receiving an object frequency response from another node, usually after calling mbnGetObjectFrequency(). Works the same as the ActuatorDataResponse() callback.


\subsection{ObjectInformationResponse}
\begin{verbatim}
 int ObjectInformationResponse(struct mbn_handler *mbn,
                               struct mbn_message *message,
                               unsigned short object,
                               struct mbn_object *info);
\end{verbatim}
Called on receiving an object information response from another node, usually after calling mbnGetObjectInformation(). Works the same as the ActuatorDataResponse() callback. The \textit{UpdateFrequency}, \textit{SensorData} and \textit{ActuatorData} fields of the \verb|mbn_object| structure are unkown and don't reflect the true status. To get this information, use the mbnGetObjectFrequency(), mbnGetSensorData() or mbnGetActuatorData() functions.


\subsection{OnlineStatus}
\begin{verbatim}
 void OnlineStatus(struct mbn_handler *mbn,
                   unsigned long addr,
                   char valid);
\end{verbatim}
Will be called to signal changes in the address status of the MambaNet node \textit{mbn}. If the \textit{valid} argument is 0, the node does not have a validated address and can thus not communicate over the network, with the exception of sending ping requests to keep the list of online nodes up-to-date.


\subsection{ReceiveMessage}
\begin{verbatim}
 int ReceiveMessage(struct mbn_handler *mbn,
                    struct mbn_message *message);
\end{verbatim}
Low-level callback, will be called for each incoming message before it has been processed by the library and before any other callback related to this message has been called.

The function can return a non-zero value to stop any further processing of this message, or 0 to let the library handle the message as it would normally do.


\subsection{SensorDataChanged}
\begin{verbatim}
 int SensorDataChanged(struct mbn_handler *mbn,
                       struct mbn_message *message,
                       unsigned short object,
                       unsigned char type,
                       union mbn_data data);
\end{verbatim}
Called on receiving a sensor data changed event from another node. Works the same as the ActuatorDataResponse() callback.


\subsection{SensorDataResponse}
\begin{verbatim}
 int SensorDataResponse(struct mbn_handler *mbn,
                        struct mbn_message *message,
                        unsigned short object,
                        unsigned char type,
                        union mbn_data data);
\end{verbatim}
Called on receiving a sensor data response from another node, usually after calling mbnGetSensorData(). Works the same as the ActuatorDataResponse() callback.


\subsection{SetActuatorData}
\begin{verbatim}
 int SetActuatorData(struct mbn_handler *mbn,
                     unsigned short object,
                     union mbn_data data);
\end{verbatim}
Called when a node on the network attempts to change the sensor data of object number \textit{object} (counting from 0) of MambaNet node \textit{mbn} to \textit{data}. The function should return 0 to indicate that the new data has been accepted or any other value otherwise. Works the same as the SetActuatorData() callback.